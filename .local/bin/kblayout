#!/bin/sh
# An edited https://github.com/porras/i3-keyboard-layout/blob/master/i3-keyboard-layout by MYDavoodeh
# Requires: xorg-setxkbmap, List also requires dmenu
# FIXME The script is relatively way too slow (especially when cycling)

def="$(echo "${KBLAYOUT:-us}" | cut -d' ' -f1)"

getl(){
    q="$(setxkbmap -query)"
    variant="$(echo "$q" | grep -oP 'variant:\s*\K\w+')" &&
        echo "$(echo "$q" | grep -oP 'layout:\s*\K\w+')-$variant" ||
        echo "$q" | grep -oP 'layout:\s*\K\w+'
    exit 0
}

setl(){ # accepts either the layout (ru) or layout and variant separated with a dash (ru-phonetic)
    setxkbmap "${1:-$def}" 2>/dev/null || setxkbmap "$(echo "${1:-$def}" | cut -d- -f1)" -variant "$(echo "${1:-$def}" | cut -d- -f2)"
}


case $1 in
    get) getl ;;
    set) setl "$2" ;;
    list | ls) setxkbmap "$(echo "$(awk '/! layout/{flag=1; next} /! variant/{flag=0} flag {print $2, "- " $1}' /usr/share/X11/xkb/rules/base.lst | dmenu -l 15)" | awk '{print $3}')" ;;
    # TODO Optimize cycling time
    cycle) shift && setl "$(echo "$@" | grep -oP ".*$(getl) +\\K[\\w-]+")" || (echo "$helpmsg" && exit) ;;
    *) setl ; echo us;;
esac

pkill -RTMIN+30 "${STATUSBAR:-dwmblocks}" # for [lang] or [kbselect] modules in blocks bars
